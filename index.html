<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HKAcadJobs ‚Äî Academic Positions in Hong Kong</title>
<meta name="description" content="Search for academic job listings across all universities in Hong Kong, all in one place.">
<meta name="keywords" content="academic jobs Hong Kong, university positions HK, faculty jobs, research jobs Hong Kong, professor openings Hong Kong, lecturer jobs Hong Kong">
<meta property="og:title" content="HKAcadJobs ‚Äî Academic Positions in Hong Kong">
<meta property="og:description" content="Search for academic job listings across all universities in Hong Kong, all in one place.">
<meta property="og:url" content="https://stringingcw-ai.github.io/hkacadjobs/">
<meta property="og:type" content="website">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     CONFIGURATION ‚Äî edit SHEET_CSV_URL below
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

  :root {
    --ink: #0f1117;
    --paper: #f5f2eb;
    --cream: #ece8df;
    --accent: #b5451b;
    --accent-soft: #f0d5cc;
    --muted: #7a7568;
    --border: #d8d3c8;
    --white: #ffffff;
    --tag-bg: #e8e4dc;
    --bookmark: #e6a817;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--paper); color: var(--ink); min-height: 100vh; overflow-x: hidden; }

  /* NAV */
  nav { background: var(--ink); padding: 0 48px; display: flex; align-items: center; justify-content: space-between; height: 60px; position: sticky; top: 0; z-index: 200; }
  .logo { font-family: 'Playfair Display', serif; color: var(--paper); font-size: 1.25rem; letter-spacing: -0.02em; }
  .logo span { color: var(--accent); }
  .nav-right { display: flex; align-items: center; gap: 20px; }
  .nav-meta { font-size: 0.75rem; color: #888; letter-spacing: 0.05em; }
  .bookmark-nav-btn { display: flex; align-items: center; gap: 7px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.15); color: var(--paper); padding: 7px 14px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; cursor: pointer; transition: background 0.2s; }
  .bookmark-nav-btn:hover { background: rgba(255,255,255,0.14); }
  .bk-count { background: var(--bookmark); color: var(--ink); font-size: 0.68rem; font-weight: 700; border-radius: 10px; padding: 1px 6px; min-width: 18px; text-align: center; display: none; }
  .bk-count.visible { display: inline-block; }

  /* HERO */
  .hero { background: var(--ink); color: var(--paper); padding: 48px 48px 40px; border-bottom: 3px solid var(--accent); }
  .hero h1 { font-family: 'Playfair Display', serif; font-size: 2.6rem; line-height: 1.1; max-width: 560px; margin-bottom: 10px; }
  .hero h1 em { color: var(--accent); font-style: normal; }
  .hero p { color: #aaa; font-size: 0.9rem; font-weight: 300; margin-bottom: 28px; }
  .stats-row { display: flex; gap: 40px; flex-wrap: wrap; }
  .stat-num { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--paper); }
  .stat-label { font-size: 0.72rem; color: #888; letter-spacing: 0.06em; text-transform: uppercase; }

  /* FILTER BAR */
  .filter-bar { background: var(--white); border-bottom: 1px solid var(--border); padding: 14px 48px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; position: sticky; top: 60px; z-index: 190; }
  .view-tabs { display: flex; background: var(--cream); border-radius: 7px; padding: 3px; border: 1px solid var(--border); }
  .view-tab { padding: 6px 16px; border-radius: 5px; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.15s; color: var(--muted); display: flex; align-items: center; gap: 6px; border: none; background: none; font-family: 'DM Sans', sans-serif; }
  .view-tab.active { background: var(--white); color: var(--ink); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .tab-count { background: var(--bookmark); color: #fff; font-size: 0.65rem; font-weight: 700; border-radius: 8px; padding: 1px 5px; display: none; }
  .tab-count.visible { display: inline-block; }
  .search-wrap { position: relative; flex: 1; min-width: 200px; max-width: 320px; }
  .search-wrap input { width: 100%; padding: 8px 12px 8px 34px; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; background: var(--paper); color: var(--ink); outline: none; transition: border-color 0.2s; }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 0.85rem; }
  select { padding: 8px 30px 8px 11px; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; background: var(--paper); color: var(--ink); outline: none; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a7568' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; transition: border-color 0.2s; }
  select:focus { border-color: var(--accent); }
  .filter-divider { width: 1px; height: 26px; background: var(--border); }
  .result-count { margin-left: auto; font-size: 0.78rem; color: var(--muted); white-space: nowrap; }
  .result-count strong { color: var(--ink); }

  /* ACTIVE FILTERS */
  .active-filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; padding: 10px 48px 12px; background: var(--white); border-bottom: 1px solid var(--border); }
  .filter-chip { display: inline-flex; align-items: center; gap: 6px; background: var(--accent-soft); color: var(--accent); border: 1px solid #d9b5a8; border-radius: 20px; padding: 4px 10px; font-size: 0.75rem; font-weight: 500; cursor: pointer; }
  .filter-label { font-size: 0.75rem; color: var(--muted); }

  /* MAIN */
  .main-layout { max-width: 100%; padding: 28px 48px 64px; }

  /* LOADING STATE */
  .loading-state { text-align: center; padding: 80px 20px; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-state p { color: var(--muted); font-size: 0.9rem; }

  /* ERROR STATE */
  .error-state { background: #fdecea; border: 1px solid #f5c6c2; border-radius: 8px; padding: 20px 24px; margin-bottom: 20px; display: none; }
  .error-state strong { color: #c0392b; display: block; margin-bottom: 6px; }
  .error-state p { font-size: 0.85rem; color: #666; }
  .error-state code { background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; }

  /* UPDATE BANNER */
  .update-banner { background: var(--accent-soft); border: 1px solid #d9b5a8; border-radius: 6px; padding: 10px 16px; font-size: 0.78rem; color: var(--accent); display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
  .update-banner .dot { width: 7px; height: 7px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* TABLE */
  .job-table-wrap { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--white); }
  table { width: 100%; border-collapse: collapse; }
  thead { background: var(--cream); border-bottom: 2px solid var(--border); }
  th { padding: 13px 16px; text-align: left; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase; color: var(--muted); white-space: nowrap; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: var(--ink); }
  th .sort-icon { margin-left: 4px; opacity: 0.4; }
  tbody tr { border-bottom: 1px solid var(--cream); transition: background 0.15s; cursor: pointer; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: #faf8f4; }
  tbody tr.highlighted { background: #fffcf8; }
  tbody tr.row-selected { background: #fff4f1 !important; box-shadow: inset 3px 0 0 var(--accent); }
  td { padding: 13px 16px; vertical-align: middle; }
  th:nth-child(5), td:nth-child(5),
  th:nth-child(6), td:nth-child(6) { text-align: center; }
  td:nth-child(5) { height: 1px; }
  .job-title { font-weight: 600; font-size: 0.88rem; color: var(--ink); margin-bottom: 3px; }
  .job-sub { font-size: 0.74rem; color: var(--muted); }
  .uni-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 0.82rem; font-weight: 500; }
  .uni-logo { width: 20px; height: 20px; object-fit: contain; border-radius: 2px; flex-shrink: 0; }
  .dept-tag { display: inline-block; background: var(--tag-bg); border-radius: 4px; padding: 3px 9px; font-size: 0.75rem; color: var(--muted); font-weight: 500; }
  .deadline-cell { font-size: 0.83rem; white-space: nowrap; }
  .days-left { display: block; font-size: 0.7rem; margin-top: 2px; }
  .days-left.urgent { color: #c0392b; font-weight: 600; }
  .days-left.soon { color: #e67e22; }
  .days-left.ok { color: #27ae60; }
  .new-badge { display: inline-block; background: var(--accent); color: white; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 2px 6px; border-radius: 3px; margin-right: 6px; vertical-align: middle; }
  .bk-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px 6px; border-radius: 4px; transition: transform 0.15s; line-height: 1; opacity: 0.3; }
  .bk-btn:hover { transform: scale(1.25); opacity: 1; }
  .bk-btn.saved { opacity: 1; }
  .apply-btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; background: var(--ink); color: var(--paper); border-radius: 5px; font-size: 0.78rem; font-weight: 500; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: background 0.15s, transform 0.1s; white-space: nowrap; text-decoration: none; }
  .apply-btn:hover { background: var(--accent); transform: translateY(-1px); }

  /* EMPTY STATES */
  .empty-state, .saved-empty { text-align: center; padding: 60px 20px; color: var(--muted); display: none; }
  .empty-state .empty-icon, .saved-empty .empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
  .saved-empty small { font-size: 0.8rem; display: block; margin-top: 6px; }

  /* PAGINATION */
  .pagination { display: flex; justify-content: center; align-items: center; gap: 6px; margin-top: 28px; flex-wrap: wrap; }
  .page-btn { min-width: 34px; height: 34px; padding: 0 8px; display: flex; align-items: center; justify-content: center; border: 1.5px solid var(--border); border-radius: 5px; font-size: 0.82rem; cursor: pointer; background: var(--white); color: var(--ink); transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--ink); color: var(--paper); border-color: var(--ink); }
  .page-dots { font-size: 0.85rem; color: var(--muted); padding: 0 4px; }

  /* PANEL */
  .panel-overlay { position: fixed; inset: 0; background: rgba(15,17,23,0.5); z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
  .panel-overlay.open { opacity: 1; pointer-events: all; }
  .detail-panel { position: fixed; top: 0; right: 0; width: min(560px, 100vw); height: 100vh; background: var(--white); z-index: 400; transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4,0,0.2,1); display: flex; flex-direction: column; box-shadow: -10px 0 50px rgba(0,0,0,0.18); }
  .detail-panel.open { transform: translateX(0); }
  .panel-header { padding: 20px 24px 18px; border-bottom: 1px solid var(--border); background: var(--cream); flex-shrink: 0; }
  .panel-header-row1 { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px; }
  .panel-close { background: none; border: 1px solid var(--border); border-radius: 6px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; color: var(--muted); transition: background 0.15s; margin-left: 12px; }
  .panel-close:hover { background: var(--border); color: var(--ink); }
  .panel-uni-row { display: flex; align-items: center; gap: 7px; margin-bottom: 6px; }
  .panel-uni-logo { width: 26px; height: 26px; object-fit: contain; border-radius: 3px; flex-shrink: 0; }
  .panel-uni-name { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; }
  .panel-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; line-height: 1.2; color: var(--ink); margin-bottom: 10px; }
  .panel-tags { display: flex; gap: 7px; flex-wrap: wrap; }
  .ptag { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 0.72rem; font-weight: 500; }
  .ptag.dept { background: var(--tag-bg); color: var(--muted); }
  .ptag.rank { background: #dce8f5; color: #2a5c8a; }
  .ptag.urgent { background: #fdecea; color: #c0392b; }
  .ptag.soon { background: #fef3e2; color: #c87000; }
  .ptag.ok { background: #e6f4ea; color: #27ae60; }
  .panel-body { flex: 1; overflow-y: auto; padding: 22px 24px; }
  .psection { margin-bottom: 22px; }
  .psection-title { font-size: 0.68rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--cream); }
  .psection p { font-size: 0.875rem; line-height: 1.75; color: #2a2a2a; }
  .psection p + p { margin-top: 10px; }
  .psection ul { padding-left: 18px; }
  .psection ul li { font-size: 0.875rem; line-height: 1.85; color: #2a2a2a; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .info-cell { background: var(--paper); border-radius: 6px; padding: 10px 14px; border: 1px solid var(--cream); }
  .info-label { font-size: 0.67rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 4px; }
  .info-val { font-size: 0.84rem; font-weight: 600; color: var(--ink); }
  .panel-footer { padding: 14px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; flex-shrink: 0; background: var(--white); }
  .panel-apply { flex: 1; padding: 11px; background: var(--ink); color: var(--paper); border: none; border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.15s; text-decoration: none; }
  .panel-apply:hover { background: var(--accent); }
  .panel-save { padding: 11px 16px; border: 1.5px solid var(--border); border-radius: 7px; background: none; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 7px; color: var(--muted); transition: all 0.15s; white-space: nowrap; }
  .panel-save:hover { border-color: var(--bookmark); color: var(--bookmark); }
  .panel-save.saved { background: #fff8e5; border-color: var(--bookmark); color: var(--bookmark); }

  footer { background: var(--ink); color: #666; text-align: center; padding: 24px 48px; font-size: 0.75rem; letter-spacing: 0.03em; }
  footer a { color: var(--accent); text-decoration: none; }

  /* GROUP CHIPS BAR */
  .group-chips-bar { background: var(--white); border-bottom: 1px solid var(--border); padding: 8px 48px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .group-bar-label { font-size: 0.72rem; color: var(--muted); font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; white-space: nowrap; }
  .group-chip { display: inline-flex; align-items: center; padding: 5px 13px; border-radius: 16px; font-size: 0.78rem; font-weight: 500; cursor: pointer; border: 1.5px solid var(--border); background: var(--white); color: var(--muted); transition: all 0.15s; user-select: none; }
  .group-chip:hover { border-color: var(--accent); color: var(--accent); }
  .group-chip.selected { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); font-weight: 600; }

  @media (max-width: 768px) {
    nav { padding: 0 20px; }
    .hero { padding: 32px 20px 28px; }
    .hero h1 { font-size: 1.9rem; }
    .filter-bar { padding: 12px 20px; }
    .active-filters { padding: 10px 20px 10px; }
    .main-layout { padding: 20px 16px 48px; }
    .nav-meta { display: none; }
    .group-chips-bar { padding: 8px 20px; }

    /* TABLE ‚Üí CARD LAYOUT on mobile */
    .job-table-wrap { border-radius: 0; border-left: none; border-right: none; background: transparent; box-shadow: none; }
    table { display: block; }
    thead { display: none; }
    tbody { display: flex; flex-direction: column; gap: 10px; }
    tbody tr { display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto auto; border: 1px solid var(--border); border-radius: 10px; background: var(--white); padding: 12px 14px; gap: 2px 8px; }
    tbody tr:last-child { border-bottom: 1px solid var(--border); }
    tbody tr.row-selected { box-shadow: inset 3px 0 0 var(--accent); }
    td { display: block; padding: 0; border: none; }
    td:nth-child(1) { display: none; }
    td:nth-child(2) { grid-column: 1; grid-row: 1; }
    td:nth-child(3) { grid-column: 2; grid-row: 1; align-self: start; justify-self: end; padding-left: 10px; position: relative; z-index: 1; }
    td:nth-child(4) { grid-column: 1; grid-row: 2; padding-top: 6px; }
    td:nth-child(5) { grid-column: 1; grid-row: 3; padding-top: 6px; display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; height: auto; }
    td:nth-child(5) > div { flex-direction: row !important; justify-content: flex-start !important; align-items: center !important; height: auto !important; }
    td:nth-child(6) { grid-column: 2; grid-row: 1 / span 3; display: flex; align-items: flex-end; justify-content: flex-end; padding-left: 10px; }
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ‚öôÔ∏è  CONFIGURATION ‚Äî PASTE YOUR GOOGLE SHEET CSV URL BELOW
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
  // 1. Open your Google Sheet
  // 2. File ‚Üí Share ‚Üí Publish to web ‚Üí Jobs sheet ‚Üí CSV ‚Üí Publish
  // 3. Copy the URL and replace the placeholder below
  // Reads jobs.csv from the same GitHub repo ‚Äî updated daily by the scraper
  const SHEET_CSV_URL = "./jobs.csv";

  // Set after CSV loads ‚Äî derived from the date_added field in the data
  let LAST_UPDATED = "";
</script>

<!-- NAV -->
<nav>
  <div class="logo">HK<span>Acad</span>Jobs</div>
  <div class="nav-right">
    <div class="nav-meta" id="navMeta">Loading‚Ä¶</div>
    <button class="bookmark-nav-btn" onclick="switchTab('saved')">
      üîñ Saved <span class="bk-count" id="navBkCount">0</span>
    </button>
  </div>
</nav>

<!-- HERO -->
<div class="hero">
  <h1>Every academic opening<br>in Hong Kong, <em>in one place.</em></h1>
  <p>Updated daily from all major HK university career portals. No more missed deadlines.</p>
  <div class="stats-row">
    <div class="stat-item"><div class="stat-num" id="statTotal">‚Äî</div><div class="stat-label">Open Positions</div></div>
    <div class="stat-item"><div class="stat-num" id="statUnis">8</div><div class="stat-label">Universities</div></div>
    <div class="stat-item"><div class="stat-num" id="statNew">‚Äî</div><div class="stat-label">New Today</div></div>
  </div>
</div>

<!-- FILTER BAR -->
<div class="filter-bar">
  <div class="view-tabs">
    <button class="view-tab active" id="tabAll" onclick="switchTab('all')">All Positions</button>
    <button class="view-tab" id="tabSaved" onclick="switchTab('saved')">
      üîñ Saved <span class="tab-count" id="tabBkCount">0</span>
    </button>
  </div>
  <div class="filter-divider"></div>
  <div class="search-wrap">
    <span class="search-icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search roles, keywords‚Ä¶" oninput="filterJobs()">
  </div>
  <select id="uniFilter" onchange="filterJobs()"><option value="">All Universities</option></select>
  <select id="areaFilter" onchange="onAreaChange()"><option value="">All Areas</option></select>
  <select id="rankFilter" onchange="filterJobs()">
    <option value="">All Ranks</option>
    <option>Professor</option>
    <option>Associate Professor</option>
    <option>Assistant Professor</option>
    <option>Postdoc</option>
    <option>Lecturer</option>
  </select>
  <div class="result-count" id="resultCount"></div>
</div>
<div class="group-chips-bar" id="groupChipsBar" style="display:none;">
  <span class="group-bar-label">Groups:</span>
  <div id="groupChips" style="display:contents;"></div>
</div>
<div class="active-filters" id="activeFilters" style="display:none;"><span class="filter-label">Filtered by:</span></div>

<!-- MAIN -->
<div class="main-layout">
  <div class="error-state" id="errorState">
    <strong>‚ö†Ô∏è Could not load job listings</strong>
    <p>The Google Sheet URL may not be configured yet, or the sheet isn't published. Check that <code>SHEET_CSV_URL</code> is set correctly in the HTML file and the sheet is published as CSV.</p>
  </div>

  <div class="update-banner" id="updateBanner" style="display:none;">
    <div class="dot"></div>
    <span id="bannerText"></span>
  </div>

  <div class="job-table-wrap" id="tableWrap">
    <div class="loading-state" id="loadingState">
      <div class="spinner"></div>
      <p>Loading positions from Google Sheets‚Ä¶</p>
    </div>
    <table id="jobTable" style="display:none;">
      <thead>
        <tr>
          <th style="width:36px;"></th>
          <th>Job Title</th>
          <th>University</th>
          <th>Department</th>
          <th class="sortable" style="min-width:140px;" onclick="sortTable('deadline')">Deadline <span class="sort-icon">‚Üï</span></th>
          <th></th>
        </tr>
      </thead>
      <tbody id="jobBody"></tbody>
    </table>
    <div class="empty-state" id="emptyState"><div class="empty-icon">üîç</div><p>No positions match your filters.</p></div>
    <div class="saved-empty" id="savedEmpty"><div class="empty-icon">üîñ</div><p>No saved positions yet.</p><small>Click üî≤ on any row to save it here.</small></div>
  </div>

  <div class="pagination" id="pagination" style="display:none;"></div>
</div>

<footer>
  HKAcadJobs ¬∑ Data sourced daily from official university career portals ¬∑
  <a href="#">About</a> ¬∑ <a href="#">Report an error</a> ¬∑ Not affiliated with any institution
</footer>

<!-- PANEL -->
<div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
<div class="detail-panel" id="detailPanel">
  <div class="panel-header">
    <div class="panel-header-row1">
      <div>
        <div class="panel-uni-row" id="panelUniRow"></div>
        <div class="panel-title" id="panelTitle"></div>
      </div>
      <button class="panel-close" onclick="closePanel()">‚úï</button>
    </div>
    <div class="panel-tags" id="panelTags"></div>
  </div>
  <div class="panel-body" id="panelBody"></div>
  <div class="panel-footer">
    <button class="panel-save" id="panelSaveBtn" onclick="toggleBookmarkPanel()">üîñ Save</button>
    <a class="panel-apply" id="panelApplyLink" href="#" target="_blank" rel="noopener">
      Apply on University Site
      <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 6.5h8M7 2.5L11 6.5 7 10.5"/></svg>
    </a>
  </div>
</div>

<script>
// ‚îÄ‚îÄ University colours (keyed by short code)
const UNI_COLORS = { HKU:'#005BAB', CUHK:'#6B3A8A', HKUST:'#003D7C', PolyU:'#8B0000', CityU:'#00843D', BU:'#C8102E', LU:'#1B4F72', EdUHK:'#E67E22' };
function uniColor(code) { return UNI_COLORS[code] || '#555555'; }

// ‚îÄ‚îÄ University display names (overrides for codes that aren't self-explanatory)
const UNI_DISPLAY = { LU: 'Lingnan' };
function uniDisplay(code) { return UNI_DISPLAY[code] || code; }
const UNI_ORDER = ['PolyU', 'EdUHK', 'LU', 'HKU', 'HKUST', 'CityU', 'HKBU', 'CUHK'];

// ‚îÄ‚îÄ University logos via Google favicon service
const UNI_LOGOS = {
  HKU:   'https://www.google.com/s2/favicons?domain=hku.hk&sz=32',
  CUHK:  'https://www.cuhk.edu.hk/favicon.ico',
  HKUST: 'https://www.google.com/s2/favicons?domain=hkust.edu.hk&sz=32',
  PolyU: 'https://www.google.com/s2/favicons?domain=polyu.edu.hk&sz=32',
  CityU: 'https://www.google.com/s2/favicons?domain=cityu.edu.hk&sz=32',
  BU:    'https://hro.hkbu.edu.hk/content/dam/hro-assets/shared-assets/logo/20210106_newLogo.svg',
  LU:    'https://www.google.com/s2/favicons?domain=ln.edu.hk&sz=32',
  EdUHK: 'https://www.google.com/s2/favicons?domain=eduhk.hk&sz=32',
};
function uniLogoHtml(code, cls) {
  const src = UNI_LOGOS[code];
  if (src) return `<img class="${cls}" src="${src}" alt="${code}" onerror="this.style.display='none'">`;
  const col = uniColor(code);
  return `<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:${col};flex-shrink:0;"></span>`;
}

// ‚îÄ‚îÄ Area groups for coarse discipline filter
const AREA_GROUPS = [
  { area: 'Medicine & Health',     kw: ['medicine','nursing','pharmacy','dental','dentistry','clinical','surgery','health','paediatric','orthopaedic','rehabilitation','ophthalmol','pathology','anaesthes','psychiatry','oncology','obstetrics','biomedical sciences','jockey club school of public'] },
  { area: 'Engineering',           kw: ['engineering','aeronautical','aviation'] },
  { area: 'Computer Science & AI', kw: ['computer','computing','data science','artificial intelligence','information systems','information technology','cybersecurity','software','ai/llm','iot'] },
  { area: 'Science & Mathematics', kw: ['mathematics','physics','chemistry','biology','ecology','earth','planetary','life science','statistics','marine','genetics','molecular','biochem','mathematical','optometry','science'] },
  { area: 'Business & Management', kw: ['business','accountancy','accounting','finance','management','marketing','economics','hotel','tourism','decision','insurance','enterprise','operations'] },
  { area: 'Arts & Humanities',     kw: ['humanities','language','literature','chinese','history','cultural','music','film','creative','visual arts','fine art','philosophy','religion','linguistic','translation','modern languages','english','digital arts','performing'] },
  { area: 'Social Sciences',       kw: ['social science','sociology','psychology','politics','political','policy','governance','journalism','communication','anthropology','criminology','public affairs','media','asian studies','china studies','area studies'] },
  { area: 'Education',             kw: ['education','curriculum','instruction','pedagogy','early childhood','learning innovation'] },
  { area: 'Law',                   kw: ['law','legal'] },
  { area: 'Architecture & Design', kw: ['architecture','design','urban','fashion','textile','building environment','construction and environment'] },
  { area: 'Administration',        kw: ['office','registry','library','human resources','services centre','services unit','safety','estates','finance office','admissions','research office','graduate school','knowledge transfer','investment','technology transfer','audit','institutional'] },
];

function classifyArea(dept) {
  if (!dept) return 'Other';
  const d = dept.toLowerCase();
  for (const {area, kw} of AREA_GROUPS) {
    if (kw.some(k => d.includes(k))) return area;
  }
  return 'Other';
}

const DEPT_GROUPS = [
  // Medicine & Health
  { group: 'Clinical Medicine',      area: 'Medicine & Health',     kw: ['surgery','orthopaedic','anaesthes','obstetrics','ophthalmol','oncology','psychiatry','paediatric','radiology','dermatology','cardiology','neurology','urology'] },
  { group: 'Nursing',                area: 'Medicine & Health',     kw: ['nursing'] },
  { group: 'Rehabilitation',         area: 'Medicine & Health',     kw: ['rehabilitation','physiotherapy','occupational therapy','speech'] },
  { group: 'Pharmacy & Biomedical',  area: 'Medicine & Health',     kw: ['pharmacy','pharmacology','biomedical sciences','biomedical science'] },
  { group: 'Public Health',          area: 'Medicine & Health',     kw: ['public health','community medicine','epidemiology','jockey club school of public'] },
  { group: 'Dentistry',              area: 'Medicine & Health',     kw: ['dental','dentistry'] },
  { group: 'Pathology',              area: 'Medicine & Health',     kw: ['pathology','laboratory medicine'] },
  // Engineering
  { group: 'Civil & Environmental',  area: 'Engineering',           kw: ['civil engineering','environmental engineering'] },
  { group: 'Mechanical & Aerospace', area: 'Engineering',           kw: ['mechanical','aeronautical','aviation','manufacturing','industrial engineering'] },
  { group: 'Electrical & Electronic',area: 'Engineering',           kw: ['electrical','electronic','photonics'] },
  { group: 'Chemical & Materials',   area: 'Engineering',           kw: ['chemical engineering','materials'] },
  { group: 'Biomedical Engineering', area: 'Engineering',           kw: ['biomedical engineering','biomechanics','bioengineering'] },
  { group: 'Systems Engineering',    area: 'Engineering',           kw: ['systems engineering','industrial and systems'] },
  // Computer Science & AI
  { group: 'Computer Science',       area: 'Computer Science & AI', kw: ['computer science','school of computing','department of computing'] },
  { group: 'AI & Data Science',      area: 'Computer Science & AI', kw: ['artificial intelligence','data science','machine learning','ai/llm','data analytics'] },
  { group: 'Information Systems',    area: 'Computer Science & AI', kw: ['information systems','information management'] },
  { group: 'Information Technology', area: 'Computer Science & AI', kw: ['information technology','iot'] },
  { group: 'Cybersecurity',          area: 'Computer Science & AI', kw: ['cybersecurity','cyber security'] },
  // Science & Mathematics
  { group: 'Mathematics & Statistics',area:'Science & Mathematics', kw: ['mathematics','statistics','actuarial','mathematical'] },
  { group: 'Physics',                area: 'Science & Mathematics', kw: ['physics','astronomy','astrophysics','planetary'] },
  { group: 'Chemistry',              area: 'Science & Mathematics', kw: ['chemistry'] },
  { group: 'Biochemistry',           area: 'Science & Mathematics', kw: ['biochem'] },
  { group: 'Biology & Life Sciences',area: 'Science & Mathematics', kw: ['biology','life science','cell biology','microbiology'] },
  { group: 'Genetics & Molecular',   area: 'Science & Mathematics', kw: ['genetics','molecular biology','genomics'] },
  { group: 'Earth & Marine Sciences',area: 'Science & Mathematics', kw: ['earth science','geology','geography','geophysics','marine','ecology','atmospheric'] },
  { group: 'Optometry',              area: 'Science & Mathematics', kw: ['optometry'] },
  // Business & Management
  { group: 'Accounting',             area: 'Business & Management', kw: ['accountancy','accounting'] },
  { group: 'Finance',                area: 'Business & Management', kw: ['finance','banking','insurance'] },
  { group: 'Management & Strategy',  area: 'Business & Management', kw: ['management','strategy','enterprise','entrepreneurship'] },
  { group: 'Marketing',              area: 'Business & Management', kw: ['marketing','advertising'] },
  { group: 'Economics',              area: 'Business & Management', kw: ['economics'] },
  { group: 'Operations & Decision',  area: 'Business & Management', kw: ['decision','operations management','supply chain','logistics'] },
  { group: 'Hospitality & Tourism',  area: 'Business & Management', kw: ['hotel','tourism','hospitality'] },
  // Arts & Humanities
  { group: 'Chinese Studies',        area: 'Arts & Humanities',     kw: ['chinese language','chinese literature','chinese studies','department of chinese','school of chinese','putonghua'] },
  { group: 'English & Linguistics',  area: 'Arts & Humanities',     kw: ['english','linguistics','linguistic'] },
  { group: 'Translation & Languages',area: 'Arts & Humanities',     kw: ['translation','interpreting','modern languages'] },
  { group: 'History & Philosophy',   area: 'Arts & Humanities',     kw: ['history','philosophy','religion','theology'] },
  { group: 'Music',                  area: 'Arts & Humanities',     kw: ['music'] },
  { group: 'Performing Arts',        area: 'Arts & Humanities',     kw: ['performing','theatre','dance'] },
  { group: 'Visual Arts & Film',     area: 'Arts & Humanities',     kw: ['visual arts','fine art','film','cinema','digital arts','creative'] },
  { group: 'Literature & Humanities',area: 'Arts & Humanities',     kw: ['literature','humanities','comparative literature'] },
  // Social Sciences
  { group: 'Psychology',             area: 'Social Sciences',       kw: ['psychology'] },
  { group: 'Sociology & Anthropology',area:'Social Sciences',       kw: ['sociology','anthropology','criminology','social science'] },
  { group: 'Politics & Policy',      area: 'Social Sciences',       kw: ['politics','political','governance','policy','public affairs'] },
  { group: 'Journalism & Media',     area: 'Social Sciences',       kw: ['journalism','communication','media'] },
  { group: 'Social Work',            area: 'Social Sciences',       kw: ['social work','social service'] },
  { group: 'Asian & Area Studies',   area: 'Social Sciences',       kw: ['asian studies','china studies','area studies'] },
  // Education
  { group: 'Teacher Education',      area: 'Education',             kw: ['teacher education','curriculum','instruction','pedagogy'] },
  { group: 'Educational Policy',     area: 'Education',             kw: ['educational policy','educational administration','higher education'] },
  { group: 'Early Childhood',        area: 'Education',             kw: ['early childhood'] },
  { group: 'Learning & Innovation',  area: 'Education',             kw: ['learning innovation','educational technology'] },
  // Law
  { group: 'Law',                    area: 'Law',                   kw: ['law','legal'] },
  // Architecture & Design
  { group: 'Architecture',           area: 'Architecture & Design', kw: ['architecture'] },
  { group: 'Urban Planning',         area: 'Architecture & Design', kw: ['urban planning','urban design','town planning'] },
  { group: 'Design',                 area: 'Architecture & Design', kw: ['design','fashion','textile'] },
  { group: 'Construction & Environment',area:'Architecture & Design',kw:['building environment','construction and environment','construction management','real estate','quantity surveying'] },
  // Administration
  { group: 'Academic Services',      area: 'Administration',        kw: ['registry','admissions','registrar'] },
  { group: 'Research & KT',          area: 'Administration',        kw: ['research office','knowledge transfer','technology transfer'] },
  { group: 'Library',                area: 'Administration',        kw: ['library'] },
  { group: 'HR & Finance',           area: 'Administration',        kw: ['human resources','finance office'] },
  { group: 'Estates & Safety',       area: 'Administration',        kw: ['estates','safety','facilities'] },
  { group: 'Graduate Studies',       area: 'Administration',        kw: ['graduate school','postgraduate'] },
];

function classifyDeptGroup(dept) {
  if (!dept) return 'Other';
  const d = dept.toLowerCase();
  for (const {group, kw} of DEPT_GROUPS) {
    if (kw.some(k => d.includes(k))) return group;
  }
  return 'Other';
}

// ‚îÄ‚îÄ State
let ALL_JOBS = [];
let filtered  = [];
let currentView = 'all';
let openJobId   = null;
let sortDir     = {};
let currentPage = 1;
const PAGE_SIZE = 20;
let selectedDeptGroups = new Set();

// ‚îÄ‚îÄ Bookmarks (localStorage)
let bookmarks = new Set(JSON.parse(localStorage.getItem('hkacad_bk') || '[]'));
function saveBookmarks() { localStorage.setItem('hkacad_bk', JSON.stringify([...bookmarks])); updateBkUI(); }
function updateBkUI() {
  const n = bookmarks.size;
  document.getElementById('navBkCount').textContent = n;
  document.getElementById('navBkCount').classList.toggle('visible', n > 0);
  document.getElementById('tabBkCount').textContent = n;
  document.getElementById('tabBkCount').classList.toggle('visible', n > 0);
}
function toggleBookmark(id, e) {
  if (e) e.stopPropagation();
  bookmarks.has(id) ? bookmarks.delete(id) : bookmarks.add(id);
  saveBookmarks();
  if (currentView === 'saved') filterJobs(); else renderTable();
  if (openJobId === id) updatePanelSaveBtn(id);
}
function toggleBookmarkPanel() { toggleBookmark(openJobId, null); }
function updatePanelSaveBtn(id) {
  const btn = document.getElementById('panelSaveBtn');
  const saved = bookmarks.has(id);
  btn.textContent = saved ? 'üîñ Saved' : 'üîñ Save';
  btn.classList.toggle('saved', saved);
}

// ‚îÄ‚îÄ Helpers
function daysLeft(s) { return Math.round((new Date(s) - new Date()) / 86400000); }
function daysLabel(d) {
  if (isNaN(d)) return {text:'',cls:''};
  if (d < 0)  return {text:'Closed',cls:'urgent'};
  if (d === 0) return {text:'Today!',cls:'urgent'};
  if (d <= 7)  return {text:`${d} days left`,cls:'urgent'};
  if (d <= 15) return {text:`${d} days left`,cls:'soon'};
  return {text:'',cls:''};
}
function fmtDate(s) {
  if (!s) return 'N/A';
  const d = new Date(s);
  return isNaN(d) ? 'N/A' : d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
}

// ‚îÄ‚îÄ CSV Parser (handles quoted fields with commas)
function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = parseCSVRow(lines[0]);
  return lines.slice(1).map(line => {
    const vals = parseCSVRow(line);
    const obj = {};
    headers.forEach((h, i) => { obj[h.trim()] = (vals[i] || '').trim(); });
    return obj;
  }).filter(r => r.title || r.id);
}
function parseCSVRow(line) {
  const result = []; let cur = ''; let inQ = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') { inQ = !inQ; }
    else if (line[i] === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += line[i]; }
  }
  result.push(cur);
  return result;
}

// ‚îÄ‚îÄ Load jobs.csv (generated by scraper, lives in same repo)
async function loadData() {
  try {
    const res = await fetch(SHEET_CSV_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status} ‚Äî jobs.csv not found. Has the scraper run yet?`);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) throw new Error('jobs.csv is empty');
    ALL_JOBS = rows.map((r, i) => ({ ...r, _id: r.id || String(i), is_new: String(r.is_new).toLowerCase() === 'true', area: classifyArea(r.department), deptGroup: classifyDeptGroup(r.department) }));
    initUI();
  } catch (err) {
    showError(err.message);
  }
}

function showError(reason) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('navMeta').textContent = 'Data unavailable';
  if (reason) {
    const detail = document.getElementById('errorState').querySelector('p');
    if (detail) detail.innerHTML += `<br><br><strong>Reason:</strong> <code>${reason}</code>`;
  }
}

function initUI() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('jobTable').style.display = 'table';

  // Derive LAST_UPDATED from the date_added field written by the scraper
  const addedDates = ALL_JOBS.map(j => j.date_added).filter(Boolean).sort();
  if (addedDates.length) {
    const d = new Date(addedDates[addedDates.length - 1]);
    if (!isNaN(d)) LAST_UPDATED = d.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
  }
  if (!LAST_UPDATED) LAST_UPDATED = new Date().toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });

  // Stats
  const newCount = ALL_JOBS.filter(j => j.is_new).length;
  const depts = new Set(ALL_JOBS.map(j => j.department).filter(Boolean));
  const unis  = new Set(ALL_JOBS.map(j => j.university).filter(Boolean));
  document.getElementById('statTotal').textContent = ALL_JOBS.length;
  document.getElementById('statNew').textContent   = newCount;
  document.getElementById('statUnis').textContent  = unis.size;
  document.getElementById('navMeta').textContent   = `UPDATED ¬∑ ${LAST_UPDATED}`;

  // Banner
  if (newCount > 0) {
    document.getElementById('updateBanner').style.display = 'flex';
    document.getElementById('bannerText').innerHTML = `<strong>${newCount} new position${newCount>1?'s':''}</strong> added ‚Äî data refreshed ${LAST_UPDATED}`;
  }

  // Populate filter dropdowns
  const uniSel  = document.getElementById('uniFilter');
  [...unis].sort().forEach(u => { const o = document.createElement('option'); o.value = u; o.textContent = u; uniSel.appendChild(o); });

  // Populate areaFilter with areas that have at least one job
  const areaFilter = document.getElementById('areaFilter');
  const presentAreas = AREA_GROUPS.map(g => g.area).filter(a => ALL_JOBS.some(j => j.area === a));
  if (ALL_JOBS.some(j => j.area === 'Other')) presentAreas.push('Other');
  presentAreas.forEach(a => { const o = document.createElement('option'); o.value = a; o.textContent = a; areaFilter.appendChild(o); });

  filterJobs();
  updateBkUI();
}

// ‚îÄ‚îÄ Area/Group cascade
function onAreaChange() {
  selectedDeptGroups.clear();
  const area = document.getElementById('areaFilter').value;
  renderGroupChips(area);
  filterJobs();
}

function renderGroupChips(area) {
  const bar = document.getElementById('groupChipsBar');
  const container = document.getElementById('groupChips');
  if (!area) { bar.style.display = 'none'; container.innerHTML = ''; return; }
  const groups = DEPT_GROUPS
    .filter(g => g.area === area && ALL_JOBS.some(j => j.area === area && j.deptGroup === g.group));
  if (!groups.length) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  container.innerHTML = '';
  groups.forEach(g => {
    const chip = document.createElement('span');
    chip.className = 'group-chip' + (selectedDeptGroups.has(g.group) ? ' selected' : '');
    chip.textContent = g.group;
    chip.onclick = () => toggleDeptGroup(g.group);
    container.appendChild(chip);
  });
}

function toggleDeptGroup(group) {
  if (selectedDeptGroups.has(group)) selectedDeptGroups.delete(group);
  else selectedDeptGroups.add(group);
  renderGroupChips(document.getElementById('areaFilter').value);
  filterJobs();
}

// ‚îÄ‚îÄ Filtering
function switchTab(tab) {
  currentView = tab;
  currentPage = 1;
  document.getElementById('tabAll').classList.toggle('active', tab === 'all');
  document.getElementById('tabSaved').classList.toggle('active', tab === 'saved');
  document.getElementById('updateBanner').style.display = (tab === 'all' && ALL_JOBS.filter(j=>j.is_new).length) ? 'flex' : 'none';
  filterJobs();
}

function filterJobs() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const uni    = document.getElementById('uniFilter').value;
  const area   = document.getElementById('areaFilter').value;
  const rank   = document.getElementById('rankFilter').value;
  const pool   = currentView === 'saved' ? ALL_JOBS.filter(j => bookmarks.has(j._id)) : ALL_JOBS;
  filtered = pool.filter(j => {
    const ms = !search || (j.title||'').toLowerCase().includes(search) || (j.department||'').toLowerCase().includes(search) || (j.university||'').toLowerCase().includes(search) || (j.university_full||'').toLowerCase().includes(search);
    return ms && (!uni||j.university===uni) && (!area||j.area===area) && (!selectedDeptGroups.size||selectedDeptGroups.has(j.deptGroup)) && (!rank||j.rank===rank);
  });
  // 1. New jobs first; 2. University order; 3. Latest date_added first within each university
  filtered.sort((a, b) => {
    const newDiff = (b.is_new ? 1 : 0) - (a.is_new ? 1 : 0);
    if (newDiff !== 0) return newDiff;
    const uiA = UNI_ORDER.indexOf(a.university), uiB = UNI_ORDER.indexOf(b.university);
    const uniDiff = (uiA === -1 ? 999 : uiA) - (uiB === -1 ? 999 : uiB);
    if (uniDiff !== 0) return uniDiff;
    const da = a.date_added ? new Date(a.date_added) : new Date(0);
    const db = b.date_added ? new Date(b.date_added) : new Date(0);
    return db - da;
  });
  currentPage = 1;
  renderTable();
  renderPagination();
  updateCount();
  renderChips();
}

// ‚îÄ‚îÄ Sorting
function sortTable(key) {
  sortDir[key] = !sortDir[key];
  filtered.sort((a, b) => {
    if (key === 'deadline') {
      const da = new Date(a.deadline), db = new Date(b.deadline);
      const va = !isNaN(da), vb = !isNaN(db);
      if (!va && !vb) return 0;
      if (!va) return 1;
      if (!vb) return -1;
      return sortDir[key] ? da - db : db - da;
    }
    const va = String(a[key]||''), vb = String(b[key]||'');
    return sortDir[key] ? va.localeCompare(vb) : vb.localeCompare(va);
  });
  renderTable();
}

// ‚îÄ‚îÄ Render
function renderTable() {
  const tbody     = document.getElementById('jobBody');
  const empty     = document.getElementById('emptyState');
  const savedMpty = document.getElementById('savedEmpty');
  tbody.innerHTML = '';

  if (currentView === 'saved' && bookmarks.size === 0) {
    savedMpty.style.display = 'block'; empty.style.display = 'none'; return;
  }
  savedMpty.style.display = 'none';
  if (!filtered.length) { empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  const start = (currentPage - 1) * PAGE_SIZE;
  const page  = filtered.slice(start, start + PAGE_SIZE);

  page.forEach(j => {
    const d    = daysLeft(j.deadline);
    const dl   = daysLabel(d);
    const col  = uniColor(j.university);
    const isBk = bookmarks.has(j._id);
    const newB = j.is_new ? `<span class="new-badge">New</span>` : '';
    const row  = document.createElement('tr');
    if (j.is_new) row.classList.add('highlighted');
    if (openJobId === j._id) row.classList.add('row-selected');
    row.onclick = () => openPanel(j._id);
    row.innerHTML = `
      <td onclick="event.stopPropagation()">
        <button class="bk-btn${isBk?' saved':''}" title="${isBk?'Remove':'Save'}" onclick="toggleBookmark('${j._id}',event)">${isBk?'üîñ':'üî≤'}</button>
      </td>
      <td>
        <div class="job-title">${newB}${j.title}</div>
      </td>
      <td><div class="uni-badge">${uniLogoHtml(j.university,'uni-logo')}${uniDisplay(j.university)||''}</div></td>
      <td><span class="dept-tag">${j.department||'N/A'}</span></td>
      <td>
        <div style="height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:6px;">
          <div class="deadline-cell">${fmtDate(j.deadline)}</div>
          ${dl.text?`<span class="ptag ${dl.cls}">‚è± ${dl.text}</span>`:''}
        </div>
      </td>
      <td onclick="event.stopPropagation()">
        <a class="apply-btn" href="${j.apply_url||'#'}" target="_blank" rel="noopener">
          Apply
          <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8" width="11" height="11"><path d="M2 6h8M6.5 2.5L10 6l-3.5 3.5"/></svg>
        </a>
      </td>`;
    tbody.appendChild(row);
  });
}

function renderPagination() {
  const total = Math.ceil(filtered.length / PAGE_SIZE);
  const pg = document.getElementById('pagination');
  pg.style.display = total <= 1 ? 'none' : 'flex';
  pg.innerHTML = '';
  if (total <= 1) return;

  const prev = document.createElement('div');
  prev.className = 'page-btn'; prev.textContent = '‚Äπ';
  prev.onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); renderPagination(); window.scrollTo(0,300); } };
  pg.appendChild(prev);

  const pages = [];
  if (total <= 7) { for(let i=1;i<=total;i++) pages.push(i); }
  else {
    pages.push(1);
    if (currentPage > 3) pages.push('‚Ä¶');
    for(let i=Math.max(2,currentPage-1);i<=Math.min(total-1,currentPage+1);i++) pages.push(i);
    if (currentPage < total-2) pages.push('‚Ä¶');
    pages.push(total);
  }
  pages.forEach(p => {
    if (p === '‚Ä¶') { const d = document.createElement('div'); d.className='page-dots'; d.textContent='‚Ä¶'; pg.appendChild(d); return; }
    const btn = document.createElement('div');
    btn.className = 'page-btn' + (p===currentPage?' active':'');
    btn.textContent = p;
    btn.onclick = () => { currentPage=p; renderTable(); renderPagination(); window.scrollTo(0,300); };
    pg.appendChild(btn);
  });

  const next = document.createElement('div');
  next.className = 'page-btn'; next.textContent = '‚Ä∫';
  next.onclick = () => { if (currentPage < total) { currentPage++; renderTable(); renderPagination(); window.scrollTo(0,300); } };
  pg.appendChild(next);
}

function updateCount() {
  const n = filtered.length;
  const label = currentView==='saved' ? 'saved position' : 'position';
  document.getElementById('resultCount').innerHTML = `<strong>${n}</strong> ${label}${n!==1?'s':''} found`;
}

function renderChips() {
  const bar = document.getElementById('activeFilters');
  const chips = [];
  const uni = document.getElementById('uniFilter').value;
  const rank = document.getElementById('rankFilter').value;
  const search = document.getElementById('searchInput').value;
  const area = document.getElementById('areaFilter').value;
  if (uni)    chips.push({label:`University: ${uni}`,   clear:()=>{document.getElementById('uniFilter').value='';filterJobs();}});
  if (area)   chips.push({label:`Area: ${area}`,        clear:()=>{document.getElementById('areaFilter').value='';selectedDeptGroups.clear();renderGroupChips('');filterJobs();}});
  if (rank)   chips.push({label:`Rank: ${rank}`,        clear:()=>{document.getElementById('rankFilter').value='';filterJobs();}});
  if (search) chips.push({label:`"${search}"`,          clear:()=>{document.getElementById('searchInput').value='';filterJobs();}});
  if (!chips.length) { bar.style.display='none'; return; }
  bar.style.display = 'flex';
  bar.innerHTML = `<span class="filter-label">Filtered by:</span>`;
  chips.forEach(c => {
    const chip = document.createElement('span');
    chip.className = 'filter-chip';
    chip.innerHTML = `${c.label} <span>√ó</span>`;
    chip.onclick = c.clear;
    bar.appendChild(chip);
  });
}

// ‚îÄ‚îÄ Detail Panel
function openPanel(id) {
  const j = ALL_JOBS.find(x => x._id === id);
  if (!j) return;
  openJobId = id;
  renderTable();
  const col = uniColor(j.university);
  const d = daysLeft(j.deadline); const dl = daysLabel(d);

  document.getElementById('panelUniRow').innerHTML = `
    ${uniLogoHtml(j.university,'panel-uni-logo')}
    <span class="panel-uni-name" style="color:${col}">${j.university_full||uniDisplay(j.university)||''}</span>`;
  document.getElementById('panelTitle').textContent = j.title || '';
  document.getElementById('panelTags').innerHTML = `
    <span class="ptag dept">${j.department||''}</span>
    ${j.rank ? `<span class="ptag rank">${j.rank}</span>` : ''}
    <span class="ptag ${dl.cls||'ok'}">‚è± ${fmtDate(j.deadline)}${dl.text?` ¬∑ ${dl.text}`:''}</span>`;

  const descHtml = (j.description||'No description provided.')
    .split('\n\n').map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('');

  document.getElementById('panelBody').innerHTML = `
    <div class="psection">
      <div class="info-grid">
        ${j.reference    ? `<div class="info-cell"><div class="info-label">Reference</div><div class="info-val">${j.reference}</div></div>` : ''}
        ${j.position_type? `<div class="info-cell"><div class="info-label">Position Type</div><div class="info-val">${j.position_type}</div></div>` : ''}
        ${j.start_date   ? `<div class="info-cell"><div class="info-label">Start Date</div><div class="info-val">${j.start_date}</div></div>` : ''}
        ${j.salary       ? `<div class="info-cell"><div class="info-label">Salary / Grade</div><div class="info-val" style="font-size:0.78rem">${j.salary}</div></div>` : ''}
      </div>
    </div>
    <div class="psection">
      <div class="psection-title">About the Role</div>
      ${descHtml}
    </div>`;

  document.getElementById('panelApplyLink').href = j.apply_url || '#';
  updatePanelSaveBtn(id);
  document.getElementById('panelOverlay').classList.add('open');
  document.getElementById('detailPanel').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closePanel() {
  openJobId = null;
  document.getElementById('panelOverlay').classList.remove('open');
  document.getElementById('detailPanel').classList.remove('open');
  document.body.style.overflow = '';
  renderTable();
}

document.addEventListener('keydown', e => { if (e.key==='Escape') closePanel(); });

// ‚îÄ‚îÄ Init
updateBkUI();
loadData();
</script>
</body>
</html>
